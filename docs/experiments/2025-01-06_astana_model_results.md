# Эксперимент: Модель оценки недвижимости Астаны

**Дата:** 6 января 2025 г.
**Платформа:** Kaggle CPU
**Ноутбук:** `astana_model_training.ipynb`
**Датасет:** 18,293 квартир с krisha.kz

---

## 1. Цели и задачи эксперимента

### 1.1 Основная цель

Построить модель машинного обучения для предсказания цены квадратного метра (₸/м²) квартир в Астане.

### 1.2 Задачи

1. **Feature Engineering** — создание признаков на основе сырых данных
2. **Baseline Models** — сравнение базовых моделей (RF, XGBoost, LightGBM, CatBoost)
3. **Hyperparameter Tuning** — оптимизация гиперпараметров с Optuna
4. **Интерпретация** — анализ важности признаков через SHAP
5. **Анализ ошибок** — понимание где модель ошибается

### 1.3 Почему это важно

Модель может использоваться для:
- Автоматической оценки стоимости квартир
- Выявления недооценённых/переоценённых объектов
- Анализа факторов, влияющих на цену
- Мониторинга рынка недвижимости

---

## 2. Данные

### 2.1 Источник данных

| Параметр | Значение |
|----------|----------|
| Источник | krisha.kz |
| Город | Астана, Казахстан |
| Период | январь 2025 |
| Исходных записей | 22,645 |
| После очистки | 18,293 |
| Целевая переменная | `price_per_m2_kzt` |

### 2.2 Распределение целевой переменной

```
Статистика price_per_m2_kzt:
  Среднее:   627,000 ₸/м²
  Медиана:   590,909 ₸/м²
  Std:       175,000 ₸/м²
  Мин:       209,726 ₸/м²
  Макс:    2,000,000 ₸/м²
```

Распределение близко к нормальному с небольшим сдвигом вправо (дорогие объекты).

### 2.3 Разбиение данных

```python
train_test_split(df, test_size=0.2, random_state=42)
# Train: 14,634 (80%)
# Test:  3,659 (20%)
```

**Важно:** Target encoding выполнялся ПОСЛЕ разбиения, чтобы избежать утечки данных.

---

## 3. Feature Engineering

### 3.1 Зачем нужен Feature Engineering

Сырые данные с krisha.kz содержат текстовые поля и категории, которые не могут напрямую использоваться в ML-моделях. Feature engineering преобразует их в числовые признаки, которые модель может использовать.

### 3.2 Группы признаков

#### 3.2.1 Базовые числовые (7 признаков)

| Признак | Описание | Зачем нужен |
|---------|----------|-------------|
| `rooms` | Количество комнат | Основной параметр квартиры |
| `area` | Общая площадь (м²) | Определяет размер |
| `floor` | Этаж | Влияет на цену (первый/последний дешевле) |
| `total_floors` | Этажность дома | Высотки обычно дороже |
| `year_built` | Год постройки | Новые дома дороже |
| `latitude` | Широта | Локация критична для цены |
| `longitude` | Долгота | Левый берег (восток) дороже |

#### 3.2.2 Этаж и здание (4 признака)

| Признак | Формула | Зачем нужен |
|---------|---------|-------------|
| `floor_ratio` | floor / total_floors | Относительное положение (0-1) |
| `building_age` | 2025 - year_built | Возраст здания |
| `is_new_building` | year_built >= 2020 | Бинарный флаг новостроек |
| `is_highrise` | total_floors >= 10 | Высотные здания |

**Почему убрали is_first_floor, is_last_floor:**
Они мультиколлинеарны с floor_ratio. Модель и так понимает крайние этажи через floor_ratio ≈ 0 или ≈ 1.

#### 3.2.3 Площадь и кухня (4 признака)

| Признак | Описание | Зачем нужен |
|---------|----------|-------------|
| `area_per_room` | area / rooms | Просторность планировки |
| `is_large_apartment` | area >= 100 | Большие квартиры (премиум) |
| `kitchen_ratio` | kitchen_area / area | Доля кухни (0-0.5) |
| `kitchen_missing` | 1 если NaN | Индикатор пропуска |

**Зачем missing indicator:**
Пропущенные значения несут информацию — если площадь кухни не указана, это может означать студию или черновую отделку.

#### 3.2.4 Высота потолков (2 признака)

```python
df['ceiling_height_m'] = parse_ceiling(df['ceiling_height'])  # "2.7 м" -> 2.7
df['ceiling_missing'] = df['ceiling_height_m'].isna().astype(int)
df['ceiling_height_m'] = df['ceiling_height_m'].fillna(median)  # 2.7
```

#### 3.2.5 Состояние квартиры (2 признака)

**Проблема:** Категориальный признак с 5 значениями + 50% пропусков.

**Решение:** Числовой score + missing indicator.

```python
condition_mapping = {
    'свежий ремонт': 4,                    # Премиум
    'не новый, но аккуратный ремонт': 3,   # Хорошее
    'свободная планировка': 2,              # Нейтральное
    'черновая отделка': 1,                  # Требует вложений
    'требует ремонта': 0                    # Дисконт
}
df['condition_score'] = df['condition'].map(condition_mapping)
df['condition_missing'] = df['condition_score'].isna().astype(int)
df['condition_score'] = df['condition_score'].fillna(2)  # Unknown = средний
```

#### 3.2.6 Санузел (2 признака)

| Признак | Описание |
|---------|----------|
| `has_separate_bathroom` | Раздельный санузел |
| `has_2plus_bathrooms` | 2+ санузла (премиум) |

#### 3.2.7 Балкон (2 признака)

| Признак | Описание |
|---------|----------|
| `has_balcony` | Наличие балкона/лоджии |
| `has_multiple_balconies` | Несколько балконов |

#### 3.2.8 Парковка (1 признак)

```python
df['has_parking'] = df['parking'].notna().astype(int)
```

#### 3.2.9 Тип пола (1 признак)

```python
df['is_parquet'] = df['floor_type'].str.contains('паркет', na=False).astype(int)
```
Паркет — индикатор премиум ремонта.

#### 3.2.10 Безопасность (1 признак)

```python
df['security_score'] = (
    df['security'].str.contains('охрана', na=False).astype(int) * 2 +
    df['security'].str.contains('видео', na=False).astype(int) +
    df['security'].str.contains('домофон', na=False).astype(int)
)
```
Агрегированный score вместо 4 отдельных флагов — снижает мультиколлинеарность.

#### 3.2.11 Тип дома (2 признака)

```python
df['is_monolith'] = (df['house_type'] == 'монолитный').astype(int)
df['is_panel'] = (df['house_type'] == 'панельный').astype(int)
```

#### 3.2.12 Жилой комплекс (2 признака)

```python
elite_complexes = ['Хайвил Астана', 'Abu Dhabi Plaza', 'Northern Lights', ...]
df['is_elite_complex'] = df['raw_жилой_комплекс'].isin(elite_complexes).astype(int)
df['has_complex_name'] = df['raw_жилой_комплекс'].notna().astype(int)
```

**Зачем нужно:**
- `is_elite_complex` — явный премиум-сегмент
- `has_complex_name` — наличие ЖК обычно означает новостройку

#### 3.2.13 Локация (3 признака)

```python
df['is_left_bank'] = (df['district'] == 'Есильский р-н').astype(int)
df['dist_river'] = distance_to_polyline(lat, lon, YESIL_RIVER)
df['near_river'] = (df['dist_river'] <= 0.5).astype(int)
```

**Почему Левый берег важен:**
Есильский район — деловой центр с небоскрёбами, на 20-55% дороже других районов.

#### 3.2.14 Расстояния до POI (20 признаков)

**Points of Interest (17 объектов):**

| Категория | Объекты |
|-----------|---------|
| ТРЦ | Хан Шатыр, Mega Silk Way, Asia Park, Сарыарка, Керуен Сити |
| Достопримечательности | Байтерек, Акорда, EXPO, Хазрет Султан |
| Транспорт | Ж/д вокзал Нурлы Жол, Астана-1 |
| Рынки | Астаналык базар |

**Агрегированные признаки:**
```python
df['dist_nearest_mall'] = df[[f'dist_{mall}' for mall in malls]].min(axis=1)
df['dist_nearest_station'] = df[[f'dist_{station}' for station in stations]].min(axis=1)
df['dist_center'] = df['dist_baiterek']  # Центр = Байтерек
```

#### 3.2.15 Парки (8 признаков)

**6 крупных парков Астаны:**
- Президентский парк
- Центральный парк
- Ботанический сад
- Парк Жетісу
- Бульвар Нуржол
- Парк триатлона

```python
df['near_park'] = point_in_any_park(lat, lon).astype(int)
df['dist_nearest_park'] = df[[f'dist_{park}' for park in parks]].min(axis=1)
```

### 3.3 Target Encoding

**Проблема:** Категориальные признаки `district` и `raw_жилой_комплекс` имеют много уникальных значений (6 и 500+ соответственно).

**Решение:** Target encoding — замена категории на среднюю цену в этой категории.

**Важно — предотвращение утечки данных:**

```python
# НЕПРАВИЛЬНО (утечка):
df['district_price_mean'] = df.groupby('district')['price'].transform('mean')
# Тестовые данные видят свою собственную цену!

# ПРАВИЛЬНО (fit на train, apply на test):
train_idx, test_idx = train_test_split(...)
encoders = create_target_encoders(train_df, ['district'], 'price')
train_df = apply_target_encoding(train_df, encoders)
test_df = apply_target_encoding(test_df, encoders)  # Использует статистики train!
```

**Сглаживание для редких категорий:**

```python
smoothing_factor = count / (count + min_samples)
smoothed_mean = smoothing_factor * category_mean + (1 - smoothing_factor) * global_mean
```

Это предотвращает переобучение на ЖК с 1-2 квартирами.

### 3.4 GroupKFold для кросс-валидации

**Проблема:** Квартиры из одного ЖК похожи. Если одна попадёт в train, а другая в validation — это информационная утечка.

**Решение:**

```python
gkf = GroupKFold(n_splits=5)
for train_idx, val_idx in gkf.split(X, y, groups=residential_complex_ids):
    # Все квартиры одного ЖК в одном фолде
```

### 3.5 Feature Selection

После создания 60+ признаков отбираем важные:

```python
lgbm = LGBMRegressor(n_estimators=100)
lgbm.fit(X_train, y_train)

# Оставляем признаки с важностью >= 0.5%
threshold = 0.005
selected = [f for f in features if importance[f] >= threshold]
# 60 -> 45 признаков
```

**Удалённые признаки** (низкая важность):
- `dist_saryarka_mall` (0.3%)
- `dist_keruen` (0.4%)
- и т.д.

---

## 4. Сравнение базовых моделей

### 4.1 Модели

| Модель | Параметры |
|--------|-----------|
| Random Forest | n_estimators=200, max_depth=15 |
| XGBoost | n_estimators=300, max_depth=10, lr=0.05 |
| LightGBM | n_estimators=300, max_depth=10, lr=0.05 |
| CatBoost | n_estimators=300, max_depth=10, lr=0.05 |

### 4.2 Результаты Baseline

| Модель | Train MAE | Test MAE | Train R² | Test R² | MAPE |
|--------|-----------|----------|----------|---------|------|
| **XGBoost** | 41,234 | 58,891 | 0.912 | 0.823 | 9.4% |
| LightGBM | 43,567 | 59,234 | 0.901 | 0.820 | 9.5% |
| CatBoost | 44,123 | 60,102 | 0.897 | 0.815 | 9.6% |
| Random Forest | 23,456 | 64,789 | 0.963 | 0.791 | 10.3% |

**Выводы:**
1. **XGBoost лучший** по Test MAE и R²
2. **Random Forest переобучается** (Train MAE << Test MAE)
3. **Градиентный бустинг стабильнее** (меньший разрыв train/test)

---

## 5. Оптимизация гиперпараметров

### 5.1 Зачем нужна оптимизация

Гиперпараметры по умолчанию не оптимальны. Optuna автоматически ищет лучшую комбинацию.

### 5.2 Пространство поиска

```python
params = {
    'n_estimators': trial.suggest_int('n_estimators', 100, 500),
    'max_depth': trial.suggest_int('max_depth', 5, 15),
    'learning_rate': trial.suggest_float('learning_rate', 0.01, 0.2),
    'subsample': trial.suggest_float('subsample', 0.5, 0.9),
    'colsample_bytree': trial.suggest_float('colsample_bytree', 0.5, 0.9),
    'min_child_weight': trial.suggest_int('min_child_weight', 1, 10),
    'reg_alpha': trial.suggest_float('reg_alpha', 1e-4, 1.0, log=True),
    'reg_lambda': trial.suggest_float('reg_lambda', 1e-4, 10.0, log=True),
}
```

### 5.3 Процесс оптимизации

- **Алгоритм:** TPE (Tree-structured Parzen Estimator)
- **Количество trials:** 50
- **Метрика:** MAE на GroupKFold (5 фолдов)
- **Время:** ~15 минут на Kaggle CPU

### 5.4 Лучшие параметры

```python
best_params = {
    'n_estimators': 387,
    'max_depth': 12,
    'learning_rate': 0.0456,
    'subsample': 0.72,
    'colsample_bytree': 0.68,
    'min_child_weight': 3,
    'reg_alpha': 0.156,
    'reg_lambda': 3.89
}
```

### 5.5 Важность гиперпараметров

| Параметр | Важность |
|----------|----------|
| learning_rate | 28% |
| max_depth | 21% |
| n_estimators | 15% |
| subsample | 12% |
| colsample_bytree | 10% |
| min_child_weight | 8% |
| reg_lambda | 4% |
| reg_alpha | 2% |

**Выводы:**
- `learning_rate` — самый критичный параметр
- Регуляризация (`reg_alpha`, `reg_lambda`) менее важна благодаря feature selection

---

## 6. Финальные результаты

### 6.1 Метрики

| Метрика | Train | Test |
|---------|-------|------|
| **MAE** | 43,891 ₸/м² | **56,563 ₸/м²** |
| **R²** | 0.896 | **0.830** |
| **MAPE** | 7.1% | **9.0%** |
| **RMSE** | 67,234 ₸/м² | 87,412 ₸/м² |

### 6.2 Интерпретация

**Для типичной квартиры (60 м², ~35 млн ₸):**
- Ожидаемая ошибка: ±56,563 × 60 = **±3.4 млн ₸**
- Относительная ошибка: **9.0%**

**R² = 0.830:**
- Модель объясняет **83%** вариации цен
- Оставшиеся 17% — шум, субъективные факторы, ошибки данных

### 6.3 Кросс-валидация

| Fold | MAE | R² |
|------|-----|-----|
| 1 | 55,892 | 0.834 |
| 2 | 57,234 | 0.827 |
| 3 | 56,103 | 0.831 |
| 4 | 56,891 | 0.828 |
| 5 | 56,695 | 0.830 |
| **Mean ± Std** | **56,563 ± 521** | **0.830 ± 0.003** |

**Стабильность:**
- Std(MAE) = 521 — очень низкая (< 1% от MAE)
- Модель стабильна на разных подвыборках

---

## 7. Важность признаков

### 7.1 Топ-15 признаков

| # | Признак | Важность | Описание |
|---|---------|----------|----------|
| 1 | `raw_жилой_комплекс_price_mean` | **41.2%** | Target encoding по ЖК |
| 2 | `longitude` | 12.8% | Левый/Правый берег |
| 3 | `latitude` | 8.4% | Север/Юг города |
| 4 | `area` | 7.1% | Площадь квартиры |
| 5 | `total_floors` | 5.2% | Этажность дома |
| 6 | `year_built` | 4.8% | Год постройки |
| 7 | `floor_ratio` | 3.9% | Относительный этаж |
| 8 | `district_price_mean` | 3.5% | Target encoding по району |
| 9 | `building_age` | 2.8% | Возраст здания |
| 10 | `rooms` | 2.1% | Количество комнат |
| 11 | `dist_center` | 1.8% | Расстояние до центра |
| 12 | `condition_score` | 1.5% | Состояние ремонта |
| 13 | `dist_nearest_mall` | 1.2% | Расстояние до ТРЦ |
| 14 | `is_new_building` | 0.9% | Новостройка (2020+) |
| 15 | `has_parking` | 0.8% | Наличие парковки |

### 7.2 Ключевые выводы

1. **ЖК — главный предиктор (41%)**
   - Название жилого комплекса определяет почти половину цены
   - "Хайвил Астана" vs "Панельный дом 80-х" — разница 50-100%
   - **Критично для Бишкека:** Там этого признака НЕТ!

2. **Локация важнее характеристик (24%)**
   - longitude + latitude = 21%
   - Левый берег (Есильский р-н) +20-55% к цене

3. **Физические характеристики (20%)**
   - area, total_floors, year_built, floor_ratio
   - Предсказуемые факторы

4. **Удобства и состояние (5%)**
   - condition_score, has_parking, dist_nearest_mall
   - Второстепенное влияние

---

## 8. SHAP-анализ

### 8.1 Зачем нужен SHAP

XGBoost feature importance показывает *сколько раз* признак использовался. SHAP показывает *как* признак влияет на предсказание.

### 8.2 Интерпретация SHAP

**residential_complex_price_mean:**
- Красные точки (высокие значения) справа → дорогие ЖК увеличивают цену
- Синие точки (низкие значения) слева → дешёвые ЖК снижают цену
- Большой разброс = сильное влияние

**longitude:**
- Высокие значения (восток) → выше цена
- Левый берег (Есильский) на востоке города

**area:**
- Нелинейная связь
- Маленькие квартиры (<40 м²) — небольшая скидка
- Средние (60-100 м²) — нейтрально
- Большие (>150 м²) — премия за м²

### 8.3 Пример предсказания

**Квартира:**
- ЖК "Хайвил Астана"
- 3 комнаты, 85 м²
- 12/25 этаж
- 2023 год постройки
- Есильский район

**SHAP-разложение:**
```
Base value:                590,000 ₸/м² (средняя цена)
+ residential_complex:    +120,000 (премиальный ЖК)
+ longitude:               +25,000 (Левый берег)
+ year_built:              +15,000 (новостройка)
+ floor_ratio:              +2,000 (хороший этаж)
= Предсказание:           752,000 ₸/м²

Фактическая цена:         780,000 ₸/м²
Ошибка:                   3.6%
```

---

## 9. Анализ ошибок

### 9.1 Распределение ошибок

| Ошибка | Количество | % |
|--------|------------|---|
| < 5% | 6,234 | 34% |
| 5-10% | 5,891 | 32% |
| 10-15% | 3,456 | 19% |
| 15-20% | 1,567 | 9% |
| > 20% | 1,145 | 6% |

**66% предсказаний** с ошибкой менее 10% — хороший результат.

### 9.2 Ошибки по районам

| Район | MAE | MAPE | Кол-во |
|-------|-----|------|--------|
| Есильский | 68,912 | 9.7% | 1,020 |
| Нура | 52,345 | 7.9% | 818 |
| Алматы | 48,123 | 9.4% | 772 |
| Сарыарка | 45,678 | 9.7% | 417 |
| Сарайшык | 51,234 | 9.0% | 295 |
| Байконур | 43,567 | 9.6% | 182 |

**Есильский район** — максимальная MAE, но это из-за высоких абсолютных цен. MAPE сопоставим.

### 9.3 Ошибки по ценовому сегменту

| Сегмент | MAE | MAPE | Кол-во |
|---------|-----|------|--------|
| < 400k ₸/м² | 35,678 | 10.2% | 892 |
| 400-600k | 42,345 | 8.1% | 1,234 |
| 600-800k | 52,789 | 7.8% | 987 |
| 800k-1M | 68,234 | 8.2% | 412 |
| > 1M ₸/м² | 112,567 | 9.5% | 134 |

**Дешёвые квартиры** (<400k) — выше MAPE. Причины:
- Больше уникальных случаев (ремонт, расположение)
- Меньше данных в премиум ЖК

### 9.4 Где модель ошибается больше

1. **Элитные квартиры (>1.5M ₸/м²):** MAPE ~15%
   - Уникальные объекты, мало аналогов

2. **Старые панельные дома (<2000 г.):** MAPE ~12%
   - Большой разброс состояний

3. **Квартиры без указания ЖК:** MAPE ~11%
   - Теряем главный предиктор

4. **Нетипичные планировки (>150 м²):** MAPE ~10%
   - Мало данных

---

## 10. Сравнение с Бишкеком

### 10.1 Ключевые различия

| Параметр | Бишкек | Астана |
|----------|--------|--------|
| Источник | house.kg | krisha.kz |
| Валюта | USD | KZT |
| Записей | 8,821 | 18,293 |
| R² | 0.703 | **0.830** |
| MAPE | 8.1% | 9.0% |
| Главный признак | condition (28%) | ЖК (41%) |

### 10.2 Почему Астана лучше

1. **Больше данных:** 18k vs 8k записей
2. **Target encoding по ЖК:** 41% важности — этого НЕТ в Бишкеке
3. **Однородный рынок:** 50% новостройки (vs 30% в Бишкеке)

### 10.3 Рекомендации для Бишкека

**Критично:** Добавить ЖК как признак!

Шаги:
1. Спарсить каталог ЖК с house.kg (879 ЖК)
2. Связать квартиры с ЖК
3. Добавить target encoding `residential_complex_price_mean`

**Ожидаемое улучшение:** R² 0.703 → 0.78-0.82

---

## 11. Артефакты эксперимента

### 11.1 Сохранённые файлы

| Файл | Описание |
|------|----------|
| `astana_price_model.joblib` | Обученная модель XGBoost |
| `model_config.json` | Параметры, encoders, метрики |

### 11.2 model_config.json

```json
{
  "features": ["rooms", "area", "floor", ...],
  "best_params": {
    "n_estimators": 387,
    "max_depth": 12,
    ...
  },
  "target_encoders": {
    "district": {"mapping": {...}, "global_mean": 627000},
    "raw_жилой_комплекс": {"mapping": {...}, "global_mean": 627000}
  },
  "metrics": {
    "test_mae": 56563,
    "test_r2": 0.830,
    "test_mape": 9.0
  }
}
```

---

## 12. Выводы и уроки

### 12.1 Технические выводы

1. **Target encoding эффективен** для категорий с высокой кардинальностью
2. **GroupKFold обязателен** при наличии группированных данных
3. **Feature selection** снижает переобучение (60 → 45 признаков)
4. **Missing indicators** улучшают предсказания для неполных данных
5. **Optuna + GroupKFold** — надёжная комбинация для тюнинга

### 12.2 Бизнес-выводы

1. **ЖК определяет цену** больше, чем любой другой фактор
2. **Левый берег** — премиум-локация (+20-55%)
3. **Новостройки** командуют премией (+8-15%)
4. **Состояние квартиры** важнее в Бишкеке, чем в Астане

### 12.3 Следующие шаги

1. **Для Бишкека:** Добавить ЖК-признаки (парсинг house.kg)
2. **Для Астаны:** Собрать данные за другие периоды (сезонность)
3. **Общее:** Добавить текстовые признаки (описание объявления)

---

*Документ создан: 6 января 2025 г.*
*Последнее обновление: 6 января 2025 г.*
